[gcode_macro START_PRINT]
gcode:
	{% set BED_TEMP=params.BED_TEMP|default(60)|float %}
	{% set EXTRUDER_TEMP=params.EXTRUDER_TEMP|default(190)|float %}
	
	# Home the printer
	G90
	M83
	G28
	
	# Preheat the bed
	M140 S{BED_TEMP}
	M190 S{BED_TEMP}
	M104 S190
	
	# Z probing sequence
	BED_MESH_CALIBRATE
	BED_MESH_PROFILE LOAD=default
	
	# Heat the extruder to the desired temperature
	M104 S{EXTRUDER_TEMP}
	M109 S{EXTRUDER_TEMP}
	
	# Prime line sequence
	#G1 Z5 F3000 ; lift
	#G1 X20 Y5 F1500 ; move to prime position
	#G1 Z0.15 F3000 ; get ready to prime
	#G92 E0 ; reset extrusion distance
	#G1 X100 E30 F600 ; prime nozzle with adjusted extrusion / E__ based on how much you like
	
	# String removal circle after priming
	#G1 Z0.2 F3000 ; adjust to 0.2mm above the bed
	#G1 Y15 F10000 ; move the toolhead in the Y direction by 15 units
	
	# Execute the circle 3 times
	#G2 I-5 J0 F10000 ; circle with 5mm radius
	#G2 I-5 J0 F10000
	#G2 I-5 J0 F10000

[gcode_macro END_PRINT]
gcode:
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # Move nozzle away from print while retracting
    G91
    G1 X-2 Y-2 E-3 F300
    # Raise nozzle by 10mm
    G1 Z20 F3000
    G90
    # Disable steppers
    M84

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
    END_PRINT
    CANCEL_PRINT_BASE {rawparams}
    G28

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_state
    PAUSE_BASE {rawparams}
    G91
    G1 E-2 F1200
    G1 Z50
    G90
    G1 X0 Y0 F6000
	
[gcode_macro RESUME]
rename_existing: RESUME_BASE
gcode:
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    G91
    G1 E2 F1200
    G90
    RESUME_BASE {rawparams}

[gcode_macro LOAD_FILAMENT]
gcode:
    {% set cooldown = printer.extruder.target<=0 %}
    {% if printer.extruder.target<200 %}
        {% set temp=params.TEMP|default(230) %}
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp-10}
    {% else %}
        {% set temp=printer.extruder.target %}
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp-10}
    {% endif %}
    G91
    G1 E40 F3000
    G1 E40 F300
    G90
    {% if cooldown %}
        SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    {% endif %}

[gcode_macro UNLOAD_FILAMENT]
gcode:
    {% set cooldown = printer.extruder.target<=0 %}
    {% if not printer.extruder.target %}
        {% set temp=params.TEMP|default(printer.configfile.settings.extruder.min_extrude_temp) %}
    {% else %}
        {% set temp=printer.extruder.target %}
    {% endif %}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp}
    G91
    G1 E-40 F600
    G1 E-40 F3000
    G90
    {% if cooldown %}
        SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    {% endif %}
